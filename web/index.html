<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mateus RAG – Chat with ADK</title>
  <style>
    :root{
      --bg:#000;                 /* OLED black */
      --panel:#0b1220;           /* deep navy */
      --panel-2:#0f172a;         /* slate */
      --accent:#2b6cf6;          /* azure blue */
      --accent-2:#1746ad;
      --text:#e5e7eb;            /* slate-200 */
      --muted:#94a3b8;           /* slate-400 */
      --ring:#1f3b8c;            /* blue-ish outline */
      --border:#1f2937;          /* slate-800 */
      --success:#22c55e;         /* green */
      --danger:#ef4444;          /* red */
      --shadow: 0 10px 30px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
    }
    html,body{height:100%; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}
    *{box-sizing:border-box}

    /* Subtle star/halo background */
    body::before{
      content:""; position:fixed; inset:-20vmax; z-index:-2;
      background:
        radial-gradient(60vmax 60vmax at 70% -10%, rgba(39,102,255,.10), transparent 50%),
        radial-gradient(40vmax 40vmax at 10% -20%, rgba(50,110,250,.08), transparent 60%),
        radial-gradient(30vmax 30vmax at 90% 110%, rgba(50,120,255,.06), transparent 60%),
        linear-gradient(#000, #020617 35%, #000);
      filter:saturate(110%);
    }

    /* Page layout */
    .wrap{max-width:980px; margin:0 auto; padding:40px 16px 24px; min-height:100%; display:flex; flex-direction:column; gap:16px}

    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{display:flex; align-items:center; gap:12px}
    .brand{width:38px; height:38px; border-radius:999px; background:linear-gradient(135deg,var(--accent),#78a6ff); box-shadow:0 6px 16px rgba(43,108,246,.35) inset, 0 2px 12px rgba(43,108,246,.35); display:grid; place-items:center}
    .brand svg{width:22px; height:22px; color:white}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .actions{display:flex; align-items:center; gap:8px}
    .btn{display:inline-grid; place-items:center; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg,var(--panel), #0a1222); color:var(--text); padding:10px; cursor:pointer; transition:transform .1s ease, border-color .2s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px); border-color:#2b6cf6aa}
    .btn:active{transform:translateY(0)}
    .btn svg{width:18px; height:18px; color:var(--text)}

    /* Chat card */
    .card{position:relative; border:1px solid var(--border); background:linear-gradient(180deg, rgba(11,18,32,.9), rgba(8,12,24,.9)); border-radius:20px; box-shadow:var(--shadow); flex:1; display:flex; flex-direction:column; overflow:hidden}

    /* Watermark bot icon */
    .watermark{position:absolute; inset:auto; right:-40px; bottom:-40px; width:320px; height:320px; opacity:.05; pointer-events:none; filter:blur(.4px)}

    /* Scrollable history */
    .chat{flex:1; overflow:auto; padding:18px 18px 10px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth}

    .row{display:flex; gap:10px; align-items:flex-start; width:100%}
    .row.user{justify-content:flex-end}

    .avatar{flex:0 0 34px; width:34px; height:34px; border-radius:50%; background:#0f1b36; border:1px solid var(--border); display:grid; place-items:center}
    .avatar svg{width:18px; height:18px; color:#9db5ff}

    .bubble{max-width:min(80ch, 90%); padding:12px 14px; border-radius:16px; border:1px solid var(--border); box-shadow:0 1px 0 rgba(255,255,255,.03) inset}
    .user .bubble{border-top-right-radius:6px; background:linear-gradient(180deg,#0d162e,#0b1327);}
    .bot .bubble{border-top-left-radius:6px; background:linear-gradient(180deg,#0b152b,#0b1325)}

    .meta{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:11px; margin:2px 2px 0}

    /* Composer */
    .composer{display:flex; gap:10px; padding:12px; border-top:1px solid var(--border); background:linear-gradient(180deg, rgba(13,19,36,.8), rgba(6,10,20,.85));}
    .field{flex:1; position:relative}
    textarea{width:100%; resize:none; min-height:48px; max-height:160px; padding:12px 44px 12px 14px; border-radius:14px; border:1px solid var(--border); background:#050914; color:var(--text); outline:none; caret-color:var(--accent); box-shadow:0 0 0 0 var(--ring); transition:box-shadow .15s ease, border-color .15s ease}
    textarea:focus{box-shadow:0 0 0 3px color-mix(in oklch, var(--accent) 35%, transparent); border-color:#355fde}
    .send{position:absolute; right:6px; bottom:6px; width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(180deg,var(--accent), #1f50df); color:white; border:none; cursor:pointer; box-shadow:0 10px 20px rgba(43,108,246,.35);}
    .send[disabled]{opacity:.5; cursor:not-allowed; box-shadow:none}
    .send svg{width:18px; height:18px}

    .hint{font-size:12px; color:var(--muted); padding:0 14px 14px}

    .tag{display:inline-block; font-size:11px; letter-spacing:.35px; color:#a5b4fc; background:#0e1530; border:1px solid var(--border); padding:2px 8px; border-radius:99px}

    .status{position:fixed; right:16px; bottom:16px; font-size:12px; color:var(--muted)}
    .status b{color:var(--text)}

    .loader{display:inline-flex; gap:5px; align-items:center}
    .dot{width:6px;height:6px;border-radius:10px;background:#7aa0ff;opacity:.8;animation:bounce 1.4s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:scale(0.8);opacity:.4}40%{transform:scale(1);opacity:1}}

    /* Small screens */
    @media (max-width:640px){
      .wrap{padding-top:20px}
      .brand{width:34px;height:34px}
      h1{font-size:18px}
      .watermark{width:250px;height:250px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div class="brand" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M7 9h10M7 13h6"/>
            <rect x="3" y="4" width="18" height="16" rx="4"/>
          </svg>
        </div>
        <div>
          <h1>Mateus RAG</h1>
          <div class="sub">Ask about the Gospel of Matthew · backed by ADK + Gemini</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="newSessionBtn" title="Start new session" aria-label="Start new session">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="card">
      <!-- watermark icon -->
      <svg class="watermark" viewBox="0 0 200 200" aria-hidden="true">
        <g fill="none" stroke="#7aa0ff" stroke-opacity=".9" stroke-width="4">
          <rect x="24" y="40" rx="22" ry="22" width="152" height="120" fill="none"/>
          <circle cx="80" cy="90" r="12"/>
          <circle cx="120" cy="90" r="12"/>
          <path d="M60 130c16 12 64 12 80 0"/>
        </g>
      </svg>

      <div id="chat" class="chat" aria-live="polite" aria-label="Chat history"></div>

      <div class="composer">
        <div class="field">
          <textarea id="input" placeholder="Write here… (Shift+Enter = new line)" rows="1"></textarea>
          <button id="sendBtn" class="send" title="Send" aria-label="Send">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
      </div>
      <div class="hint">Tip: cite chapter & verse (e.g., <span class="tag">Mt 5:3–10</span>). New session = top‑right + button.</div>
    </div>
  </div>

  <div class="status" id="status">API: <b>disconnected</b></div>

  <script>
    // ========= CONFIG =========
    const API_BASE = localStorage.getItem('adk_api_base') || 'http://localhost:8000';
    const APP_NAME = localStorage.getItem('adk_app_name') || 'mateus_rag'; // folder name in your ADK agents dir

    // ========= STATE =========
    let userId = localStorage.getItem('adk_user_id');
    if(!userId){ userId = `u_${(crypto?.randomUUID?.()||Math.random().toString(36).slice(2))}`; localStorage.setItem('adk_user_id', userId); }

    let sessionId = newSessionId();
    let sending = false;

    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const newSessionBtn = document.getElementById('newSessionBtn');
    const statusEl = document.getElementById('status');

    // ========= UI HELPERS =========
    function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    function row(role, html){
      const isUser = role === 'user';
      const wrap = document.createElement('div');
      wrap.className = `row ${isUser ? 'user' : 'bot'}`;

      const av = document.createElement('div');
      av.className = 'avatar';
      av.innerHTML = isUser ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 00-16 0"/><circle cx="12" cy="7" r="4"/></svg>' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="4"/><path d="M7 9h10M7 13h6"/></svg>';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = html;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = now();

      if(isUser){ wrap.appendChild(bubble); wrap.appendChild(av); }
      else { wrap.appendChild(av); wrap.appendChild(bubble); }
      bubble.appendChild(meta);
      return wrap;
    }

    function addMessage(role, text){
      const safe = escapeHtml(text).replace(/\n/g, '<br>');
      const el = row(role, `<div>${safe}</div>`);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
      return el;
    }

    function addLoader(){
      const el = row('bot', `<div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
      return el;
    }

    function replaceLoader(el, role, text){
      el.remove();
      return addMessage(role, text);
    }

    function escapeHtml(str){
      const d = document.createElement('div'); d.textContent = String(str ?? ''); return d.innerHTML;
    }

    function newSessionId(){ return `s_${(crypto?.randomUUID?.()||Math.random().toString(36).slice(2))}`; }

    // ========= ADK API =========
    async function ensureSession(){
      try {
        const r = await fetch(`${API_BASE}/apps/${encodeURIComponent(APP_NAME)}/users/${encodeURIComponent(userId)}/sessions/${encodeURIComponent(sessionId)}`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({state:{}})
        });
        statusEl.innerHTML = `API: <b>${r.ok? 'connected' : 'error ' + r.status}</b>`;
        return r.ok;
      } catch (err){
        statusEl.innerHTML = `API: <b>network error</b>`;
        console.error(err);
        return false;
      }
    }

    async function sendMessage(){
      const text = inputEl.value.trim();
      if(!text || sending) return;
      sending = true; sendBtn.disabled = true;
      addMessage('user', text);
      inputEl.value = '';
      const loader = addLoader();

      try {
        const payload = {
          app_name: APP_NAME,
          user_id: userId,
          session_id: sessionId,
          new_message: { role: 'user', parts: [{ text }] },
          streaming: false
        };
        const res = await fetch(`${API_BASE}/run`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if(!res.ok){
          const msg = `HTTP ${res.status} – ${res.statusText}`;
          replaceLoader(loader, 'bot', `Oops. ${msg}. Check the ADK API server & CORS.`);
          return;
        }
        const events = await res.json();
        const reply = extractModelText(events) || '[no text returned]';
        replaceLoader(loader, 'bot', reply);
      } catch (err){
        console.error(err);
        replaceLoader(loader, 'bot', 'Network error. Is the ADK API running?');
      } finally {
        sending = false; sendBtn.disabled = false; inputEl.focus();
      }
    }

    function extractModelText(events){
      if(!Array.isArray(events)) return '';
      // Collect any part.text from events. Prefer model authored content if present.
      let out='';
      for(const ev of events){
        const author = ev?.author || ev?.content?.role || '';
        const parts = ev?.content?.parts || [];
        for(const p of parts){ if(p?.text) out += p.text; }
      }
      return out.trim();
    }

    // ========= WIRE UP =========
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    newSessionBtn.addEventListener('click', async ()=>{
      sessionId = newSessionId();
      chatEl.innerHTML = '';
      await ensureSession();
      addMessage('bot', 'New session started. How can I help with the Gospel of Matthew?');
    });

    // Initial kick
    (async function init(){
      await ensureSession();
      addMessage('bot', 'Olá! Pergunte algo sobre o Evangelho de Mateus. Cito capítulo e versículo (ex.: Mt 5:3–10).');
      inputEl.focus();
    })();
  </script>
</body>
</html>
