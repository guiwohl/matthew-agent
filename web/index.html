<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Chat — mateus_rag (ADK)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0b0b; --fg:#eaeaea; --muted:#9a9a9a; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; }
    .wrap { max-width:720px; margin:0 auto; padding:16px; display:flex; flex-direction:column; height:100%; gap:12px; }
    h1 { font-size:16px; margin:0; color:var(--muted); font-weight:600; }
    .chat { flex:1; overflow:auto; border:1px solid #222; border-radius:10px; padding:10px; background:#101010; }
    .row { display:flex; gap:8px; align-items:flex-end; }
    .msg { max-width:80%; padding:8px 10px; border-radius:10px; white-space:pre-wrap; word-wrap:break-word; }
    .me   { background:#1b1b1b; align-self:flex-end; border:1px solid #222; }
    .bot  { background:#121a26; border:1px solid #1e293b; }
    .muted{ color:var(--muted); font-size:12px; }
    .input { display:flex; gap:8px; }
    input[type=text] { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #222; background:#0f0f0f; color:var(--fg); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #222; background:#151515; color:var(--fg); cursor:pointer; }
    button:hover { background:#1a1a1a; }
    .bar { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .tiny { font-size:11px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>mateus_rag • ADK REST</h1>
      <div class="tiny">API: <span id="apiBaseTxt">http://localhost:8000</span></div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="form" class="input" autocomplete="off">
      <input id="q" type="text" placeholder="Pergunte algo sobre Mateus…" required />
      <button id="sendBtn" type="submit">Enviar</button>
      <button id="clearBtn" type="button" title="Limpar">Limpar</button>
    </form>

    <div class="tiny">
      Cria sessão se preciso e usa <code>POST /run</code>.
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = 'http://localhost:8000';
    const APP_NAME = 'mateus_rag';
    let USER_ID    = localStorage.getItem('adk_user_id')    || save('adk_user_id', 'u_' + rand());
    let SESSION_ID = localStorage.getItem('adk_session_id') || save('adk_session_id', 's_' + rand());

    // ====== HELPERS ======
    function rand(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function save(k,v){ localStorage.setItem(k,v); return v; }
    function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
    function scrollBottom(){ const c=document.getElementById('chat'); c.scrollTop = c.scrollHeight; }
    function addMsg(text, who='bot'){ const div=el('div','row'); const msg=el('div','msg '+(who==='me'?'me':'bot')); msg.textContent=text; div.appendChild(msg); document.getElementById('chat').appendChild(div); scrollBottom(); }
    function addNote(text){ const d=el('div','muted', text); document.getElementById('chat').appendChild(d); scrollBottom(); }

    // ========= SESSIONS =========
    async function ensureSession(){
      const getUrl = `${API_BASE}/apps/${encodeURIComponent(APP_NAME)}/users/${encodeURIComponent(USER_ID)}/sessions/${encodeURIComponent(SESSION_ID)}`;
      let ok = await fetch(getUrl, { method:'GET' }).then(r => r.ok).catch(()=>false);
      if(ok) return;

      const base = `${API_BASE}/apps/${encodeURIComponent(APP_NAME)}/users/${encodeURIComponent(USER_ID)}/sessions`;
      let created = await fetch(base, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ session_id: SESSION_ID, state: {} })
      }).then(r => r.ok).catch(()=>false);
      if(created) return;

      const postIdUrl = `${base}/${encodeURIComponent(SESSION_ID)}`;
      created = await fetch(postIdUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ state: {} })
      }).then(r => r.ok).catch(()=>false);
      if(created) return;

      // Fallback: pede id novo
      try{
        const r = await fetch(base, {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({ state: {} })
        });
        if(r.ok){
          const j = await r.json().catch(()=>null);
          const newId = (j && (j.id || j.session_id)) || ('s_'+rand());
          SESSION_ID = save('adk_session_id', newId);
          return;
        }
      }catch(_){}
      throw new Error('Falha ao criar sessão');
    }

    // ========= RUN =========
    async function callADK(question){
      await ensureSession();

      const body = {
        app_name: APP_NAME,
        // compat: snake + camel
        user_id: USER_ID,  session_id: SESSION_ID,
        userId: USER_ID,   sessionId: SESSION_ID,
        new_message: { role: 'user', parts: [ { text: question } ] },
        streaming: false
      };

      const r = await fetch(API_BASE + '/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const t = await r.text().catch(()=>String(r.status));
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      const json = await r.json();
      // console.debug('ADK /run resp:', json); // útil se precisar
      return json;
    }

    // ========= PARSE ROBUSTO =========
    // Coleta todo texto em "parts[].text" e variantes, percorrendo profundamente.
    function collectTextsDeep(node, out){
      if (!node) return;
      if (Array.isArray(node)) { for (const it of node) collectTextsDeep(it, out); return; }
      if (typeof node !== 'object') return;

      // 1) content.parts[].text
      if (node.content && Array.isArray(node.content.parts)) {
        for (const p of node.content.parts) {
          if (p && typeof p.text === 'string' && p.text.trim()) out.push(p.text);
        }
      }
      // 2) message.content.parts[].text
      if (node.message && node.message.content && Array.isArray(node.message.content.parts)) {
        for (const p of node.message.content.parts) {
          if (p && typeof p.text === 'string' && p.text.trim()) out.push(p.text);
        }
      }
      // 3) response.parts[].text
      if (node.response && Array.isArray(node.response.parts)) {
        for (const p of node.response.parts) {
          if (p && typeof p.text === 'string' && p.text.trim()) out.push(p.text);
        }
      }
      // 4) candidates[].content.parts[].text (estilo Gemini)
      if (Array.isArray(node.candidates)) {
        for (const c of node.candidates) {
          if (c && c.content && Array.isArray(c.content.parts)) {
            for (const p of c.content.parts) {
              if (p && typeof p.text === 'string' && p.text.trim()) out.push(p.text);
            }
          }
        }
      }
      // 5) delta/choice-like
      if (Array.isArray(node.choices)) {
        for (const ch of node.choices) {
          const t = ch?.message?.content;
          if (typeof t === 'string' && t.trim()) out.push(t);
        }
      }
      // 6) fallback: se houver "text" direto e for string
      if (typeof node.text === 'string' && node.text.trim()) out.push(node.text);

      // continuar descendo (defensivo)
      for (const k in node) {
        if (k === 'parts') continue; // já tratamos
        collectTextsDeep(node[k], out);
      }
    }

    function extractText(resp){
      const out = [];
      // resp pode ser array de events ou um objeto
      collectTextsDeep(resp, out);
      // junta e limpa duplicatas triviais
      const joined = out.join('\n').trim();
      return joined || '';
    }

    // ========= UI =========
    document.getElementById('apiBaseTxt').textContent = API_BASE;

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const input = document.getElementById('q');
      const q = input.value.trim();
      if(!q) return;
      input.value = '';
      addMsg(q,'me');
      addNote('…consultando agente…');

      try{
        const resp = await callADK(q);

        // remove último "…consultando…"
        const chat = document.getElementById('chat');
        const notes = chat.querySelectorAll('.muted');
        if(notes.length) chat.removeChild(notes[notes.length-1]);

        const text = extractText(resp) || '(sem texto do modelo)';
        addMsg(text,'bot');
      }catch(err){
        addMsg('Erro: ' + (err?.message || String(err)),'bot');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', async ()=>{
      document.getElementById('chat').innerHTML = '';
      SESSION_ID = save('adk_session_id','s_'+rand());
      addNote('Histórico limpo. Nova sessão criada.');
      try{ await ensureSession(); addNote('Sessão pronta.'); }catch(e){ addNote('Falha ao criar sessão: ' + (e?.message || e)); }
    });

    // Boot: tenta validar/criar sessão
    (async ()=>{ try{ await ensureSession(); }catch(_){/* silencioso */} })();

    addNote('Pronto. Pergunte algo (ex.: "Em qual versículo Jesus chama Mateus?").');
  </script>
</body>
</html>
